<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>P2P WhatsApp Clone Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat { width: 100%; height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; }
    input[type="text"] { width: calc(100% - 90px); }
    button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>P2P WhatsApp Clone Demo</h1>
  <p>Room ID: <span id="room-id"></span></p>
  <div id="chat"></div>
  <br>
  <input type="text" id="messageInput" placeholder="Type a message" />
  <button id="sendButton">Send</button>

  <!-- Include PeerJS library from CDN -->
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script>
    // Get or generate room id from URL query parameter.
    const urlParams = new URLSearchParams(window.location.search);
    let room = urlParams.get("room");
    if (!room) {
      room = Math.random().toString(36).substr(2, 6);
      const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + room;
      window.history.pushState({ path: newUrl }, '', newUrl);
    }
    document.getElementById("room-id").textContent = room;

    let peer;
    let conn;

    // Log messages to the chat div.
    function logMessage(msg) {
      const p = document.createElement("p");
      p.textContent = msg;
      const chatDiv = document.getElementById("chat");
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Initialize the Peer connection.
    function initPeer() {
      // Try to become the host using a fixed ID based on the room.
      peer = new Peer(room + '-host', { debug: 2 });

      peer.on('open', function(id) {
        console.log('Host peer open: ' + id);
        logMessage("Waiting for peer to join...");
      });

      // If the host id is already taken, this error will occur.
      // In that case, become the guest.
      peer.on('error', function(err) {
        console.log('Peer error:', err);
        if (err.type === 'unavailable-id') {
          // Host already exists, so become the guest.
          peer = new Peer(room + '-guest', { debug: 2 });
          peer.on('open', function(id) {
            console.log('Guest peer open: ' + id);
            logMessage("Connecting to host...");
            // Connect to the host.
            conn = peer.connect(room + '-host');
            setupConnection();
          });
        } else {
          logMessage("Peer error: " + err);
        }
      });

      // For host: when a connection is received, set it up.
      peer.on('connection', function(connection) {
        conn = connection;
        setupConnection();
      });
    }

    // Set up data channel event handlers.
    function setupConnection() {
      conn.on('open', function() {
        logMessage("Connection established.");
      });
      conn.on('data', function(data) {
        logMessage("Peer: " + data);
      });
      conn.on('error', function(err) {
        console.error("Connection error:", err);
      });
    }

    // Send a chat message when the button is clicked.
    document.getElementById("sendButton").addEventListener("click", function() {
      const message = document.getElementById("messageInput").value;
      if (conn && conn.open) {
        conn.send(message);
        logMessage("You: " + message);
        document.getElementById("messageInput").value = "";
      } else {
        logMessage("Connection not open yet.");
      }
    });

    // Start the peer initialization.
    initPeer();
  </script>
</body>
</html>
